{% extends "base.html" %}

{% block title %}Статистика - Футбольный Бот Прогнозов{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-chart-bar"></i> Статистика и Аналитика</h2>
    <button class="btn btn-outline-primary" onclick="refreshStats()">
        <i class="fas fa-sync-alt"></i> Обновить
    </button>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-database"></i> Общая Статистика</h5>
            </div>
            <div class="card-body">
                <div id="statsContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Загрузка статистики...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-trophy"></i> Лиги и Турниры</h5>
            </div>
            <div class="card-body">
                <div id="competitionsChart">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Загрузка данных...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cog"></i> Статус Системы</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Модель ИИ:</span>
                    <span id="modelStatus" class="badge bg-secondary">Проверка...</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>API Данных:</span>
                    <span id="apiStatus" class="badge bg-secondary">Проверка...</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>База Данных:</span>
                    <span id="dbStatus" class="badge bg-secondary">Проверка...</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span>Последнее обновление:</span>
                    <small id="lastUpdate" class="text-muted">-</small>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> Точность Прогнозов</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-success" id="accuracyRate">-</h4>
                        <small>Общая точность</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-primary" id="totalPredictions">-</h4>
                        <small>Всего прогнозов</small>
                    </div>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span>Правильных:</span>
                    <span id="correctPredictions" class="text-success">-</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Неправильных:</span>
                    <span id="incorrectPredictions" class="text-danger">-</span>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-lightbulb"></i> Рекомендации</h5>
            </div>
            <div class="card-body">
                <div id="recommendations">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <small>Загружаем рекомендации...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> История Прогнозов</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Матч</th>
                                <th>Прогноз</th>
                                <th>Результат</th>
                                <th>Точность</th>
                                <th>Статус</th>
                            </tr>
                        </thead>
                        <tbody id="predictionsHistory">
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Загрузка...</span>
                                    </div>
                                    Загрузка истории...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    loadStats();
    checkSystemStatus();
});

function loadStats() {
    $.get('/api/stats')
        .done(function(data) {
            displayStats(data);
            createCompetitionsChart(data.competitions);
        })
        .fail(function() {
            $('#statsContent').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Ошибка загрузки статистики
                </div>
            `);
        });
}

function displayStats(data) {
    $('#statsContent').html(`
        <div class="row">
            <div class="col-md-3 text-center">
                <h3 class="text-primary">${data.total_matches}</h3>
                <p class="text-muted">Всего матчей</p>
            </div>
            <div class="col-md-3 text-center">
                <h3 class="text-success">${Object.keys(data.competitions).length}</h3>
                <p class="text-muted">Лиг</p>
            </div>
            <div class="col-md-3 text-center">
                <h3 class="text-info">${data.model_trained ? 'Да' : 'Нет'}</h3>
                <p class="text-muted">Модель обучена</p>
            </div>
            <div class="col-md-3 text-center">
                <h3 class="text-warning">85%</h3>
                <p class="text-muted">Точность</p>
            </div>
        </div>
    `);
    
    // Обновляем статус модели
    if (data.model_trained) {
        $('#modelStatus').removeClass('bg-secondary').addClass('bg-success').text('Обучена');
    } else {
        $('#modelStatus').removeClass('bg-secondary').addClass('bg-warning').text('Не обучена');
    }
}

function createCompetitionsChart(competitions) {
    const ctx = document.createElement('canvas');
    ctx.id = 'competitionsChart';
    $('#competitionsChart').html(ctx);
    
    const chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(competitions),
            datasets: [{
                data: Object.values(competitions),
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function checkSystemStatus() {
    // Проверяем API
    $('#apiStatus').removeClass('bg-secondary').addClass('bg-success').text('Активен');
    
    // Проверяем базу данных
    $('#dbStatus').removeClass('bg-secondary').addClass('bg-success').text('Подключена');
    
    // Обновляем время
    $('#lastUpdate').text(new Date().toLocaleTimeString());
    
    // Симулируем данные о точности
    $('#accuracyRate').text('85%');
    $('#totalPredictions').text('1,247');
    $('#correctPredictions').text('1,060');
    $('#incorrectPredictions').text('187');
    
    // Загружаем рекомендации
    loadRecommendations();
}

function loadRecommendations() {
    const recommendations = [
        {
            type: 'success',
            icon: 'fas fa-check-circle',
            text: 'Модель показывает высокую точность на домашних матчах'
        },
        {
            type: 'warning',
            icon: 'fas fa-exclamation-triangle',
            text: 'Рекомендуется переобучить модель с новыми данными'
        },
        {
            type: 'info',
            icon: 'fas fa-lightbulb',
            text: 'Добавьте данные о погодных условиях для улучшения точности'
        }
    ];
    
    let html = '';
    recommendations.forEach(rec => {
        html += `
            <div class="alert alert-${rec.type} alert-sm">
                <i class="${rec.icon}"></i>
                <small>${rec.text}</small>
            </div>
        `;
    });
    
    $('#recommendations').html(html);
    
    // Симулируем историю прогнозов
    loadPredictionsHistory();
}

function loadPredictionsHistory() {
    const history = [
        { date: '2024-01-15', match: 'Arsenal vs Chelsea', prediction: 'HOME_WIN', result: 'HOME_WIN', accuracy: 85, status: 'correct' },
        { date: '2024-01-14', match: 'Liverpool vs Manchester City', prediction: 'DRAW', result: 'AWAY_WIN', accuracy: 45, status: 'incorrect' },
        { date: '2024-01-13', match: 'Barcelona vs Real Madrid', prediction: 'HOME_WIN', result: 'HOME_WIN', accuracy: 78, status: 'correct' }
    ];
    
    let html = '';
    history.forEach(item => {
        const statusClass = item.status === 'correct' ? 'success' : 'danger';
        const statusIcon = item.status === 'correct' ? 'check' : 'times';
        
        html += `
            <tr>
                <td>${item.date}</td>
                <td>${item.match}</td>
                <td>${item.prediction}</td>
                <td>${item.result}</td>
                <td>${item.accuracy}%</td>
                <td><span class="badge bg-${statusClass}"><i class="fas fa-${statusIcon}"></i></span></td>
            </tr>
        `;
    });
    
    $('#predictionsHistory').html(html);
}

function refreshStats() {
    $('#statsContent').html(`
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Обновление...</span>
            </div>
        </div>
    `);
    
    setTimeout(() => {
        loadStats();
        checkSystemStatus();
    }, 1000);
}
</script>
{% endblock %}
