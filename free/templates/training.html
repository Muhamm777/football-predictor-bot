{% extends "base.html" %}

{% block title %}Обучение Модели - Футбольный Бот Прогнозов{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-brain"></i> Обучение Модели ИИ</h4>
            </div>
            <div class="card-body">
                <p>
                    Для создания точных прогнозов модель машинного обучения должна быть обучена на исторических данных.
                    Нажмите кнопку ниже, чтобы начать процесс обучения.
                </p>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Внимание:</strong> Обучение модели может занять несколько минут. 
                    В это время не закрывайте страницу.
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg" id="trainBtn" onclick="startTraining()">
                        <i class="fas fa-play"></i> Начать Обучение
                    </button>
                </div>
                
                <div id="trainingProgress" class="mt-4" style="display: none;">
                    <h5>Прогресс Обучения</h5>
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" id="progressBar">
                        </div>
                    </div>
                    <div id="trainingStatus" class="text-muted">
                        Подготовка данных...
                    </div>
                </div>
                
                <div id="trainingResults" class="mt-4" style="display: none;">
                    <h5>Результаты Обучения</h5>
                    <div class="card bg-light">
                        <div class="card-body">
                            <div id="resultsContent">
                                <!-- Результаты будут загружены здесь -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> О Процессе Обучения</h5>
            </div>
            <div class="card-body">
                <h6>Что происходит:</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-check text-success"></i> Загрузка исторических данных</li>
                    <li><i class="fas fa-check text-success"></i> Подготовка признаков</li>
                    <li><i class="fas fa-check text-success"></i> Обучение алгоритма</li>
                    <li><i class="fas fa-check text-success"></i> Валидация модели</li>
                    <li><i class="fas fa-check text-success"></i> Сохранение модели</li>
                </ul>
                
                <hr>
                
                <h6>Используемые Алгоритмы:</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-robot text-primary"></i> Gradient Boosting</li>
                    <li><i class="fas fa-chart-line text-info"></i> Random Forest</li>
                    <li><i class="fas fa-database text-warning"></i> Feature Engineering</li>
                </ul>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Текущий Статус</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <span>Модель:</span>
                    <span id="modelStatus" class="badge bg-secondary">Проверка...</span>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <span>Последнее обучение:</span>
                    <span id="lastTraining" class="text-muted">Неизвестно</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-lightbulb"></i> Советы по Улучшению Точности</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Качество Данных:</h6>
                        <ul>
                            <li>Используйте актуальные статистики команд</li>
                            <li>Включайте данные о травмах игроков</li>
                            <li>Учитывайте погодные условия</li>
                            <li>Анализируйте форму команд</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Регулярное Обновление:</h6>
                        <ul>
                            <li>Переобучайте модель еженедельно</li>
                            <li>Добавляйте новые данные о матчах</li>
                            <li>Мониторьте точность прогнозов</li>
                            <li>Корректируйте параметры модели</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    checkModelStatus();
});

function checkModelStatus() {
    $.get('/api/stats')
        .done(function(data) {
            if (data.model_trained) {
                $('#modelStatus').removeClass('bg-secondary').addClass('bg-success').text('Обучена');
                $('#lastTraining').text('Недавно');
            } else {
                $('#modelStatus').removeClass('bg-secondary').addClass('bg-warning').text('Не обучена');
            }
        })
        .fail(function() {
            $('#modelStatus').removeClass('bg-secondary').addClass('bg-danger').text('Ошибка');
        });
}

function startTraining() {
    $('#trainBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Обучение...');
    $('#trainingProgress').show();
    
    // Симуляция прогресса
    let progress = 0;
    const interval = setInterval(function() {
        progress += Math.random() * 15;
        if (progress > 100) progress = 100;
        
        $('#progressBar').css('width', progress + '%');
        
        if (progress < 30) {
            $('#trainingStatus').text('Загрузка исторических данных...');
        } else if (progress < 60) {
            $('#trainingStatus').text('Подготовка признаков...');
        } else if (progress < 90) {
            $('#trainingStatus').text('Обучение алгоритма...');
        } else {
            $('#trainingStatus').text('Сохранение модели...');
        }
        
        if (progress >= 100) {
            clearInterval(interval);
            performTraining();
        }
    }, 500);
}

function performTraining() {
    $.post('/api/train')
        .done(function(response) {
            $('#trainingStatus').text('Обучение завершено!');
            $('#trainingResults').show();
            
            $('#resultsContent').html(`
                <div class="row">
                    <div class="col-md-6">
                        <h6>Метрики Модели:</h6>
                        <ul class="list-unstyled">
                            <li><strong>Точность:</strong> ${(response.metrics.accuracy * 100).toFixed(1)}%</li>
                            <li><strong>Тип модели:</strong> ${response.metrics.model_type}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Важные Признаки:</h6>
                        <ul class="list-unstyled">
                            ${Object.entries(response.metrics.feature_importance)
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 3)
                                .map(([feature, importance]) => 
                                    `<li><strong>${feature}:</strong> ${(importance * 100).toFixed(1)}%</li>`
                                ).join('')}
                        </ul>
                    </div>
                </div>
                <div class="alert alert-success mt-3">
                    <i class="fas fa-check-circle"></i>
                    <strong>Успешно!</strong> ${response.message}
                </div>
            `);
            
            $('#trainBtn').prop('disabled', false).html('<i class="fas fa-play"></i> Начать Обучение');
            checkModelStatus();
        })
        .fail(function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Неизвестная ошибка';
            $('#trainingStatus').text('Ошибка: ' + error);
            $('#trainBtn').prop('disabled', false).html('<i class="fas fa-play"></i> Начать Обучение');
        });
}
</script>
{% endblock %}
